# SmartFox CI/CD - Self-hosted Runner ç‰ˆæœ¬

æœ¬é¡¹ç›®é…ç½®ä¸ºä½¿ç”¨ **self-hosted runner** è¿è¡Œ GitHub Actionsï¼Œæä¾›æ›´å¥½çš„æ€§èƒ½æ§åˆ¶å’Œå®šåˆ¶åŒ–ç¯å¢ƒã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å¯¹äº macOS ç”¨æˆ·

1. **è‡ªåŠ¨è®¾ç½®ç¯å¢ƒ**ï¼ˆæ¨èï¼‰ï¼š
   ```bash
   ./scripts/setup-macos-runner.sh
   ```

2. **æ‰‹åŠ¨éªŒè¯ç¯å¢ƒ**ï¼š
   ```bash
   ./scripts/verify-runner-env-macos.sh
   ```

3. **è®¾ç½® GitHub Actions Runner**ï¼š
   æŒ‰ç…§ [macOS è®¾ç½®æŒ‡å—](docs/self-hosted-runner-setup-macos.md) è¿›è¡Œé…ç½®

### å¯¹äºå…¶ä»–æ“ä½œç³»ç»Ÿ

æŸ¥çœ‹é€šç”¨è®¾ç½®æŒ‡å—ï¼š[Self-hosted Runner è®¾ç½®](docs/self-hosted-runner-setup.md)

## ğŸ“‹ ç³»ç»Ÿè¦æ±‚

### æœ€ä½è¦æ±‚
- **å†…å­˜**: 8GB RAM
- **CPU**: 4 æ ¸å¿ƒ
- **å­˜å‚¨**: 50GB å¯ç”¨ç©ºé—´
- **ç½‘ç»œ**: ç¨³å®šçš„äº’è”ç½‘è¿æ¥

### æ¨èé…ç½®
- **å†…å­˜**: 16GB RAM
- **CPU**: 8 æ ¸å¿ƒ
- **å­˜å‚¨**: 100GB SSD
- **ç½‘ç»œ**: é«˜é€Ÿå®½å¸¦è¿æ¥

## ğŸ› ï¸ å¿…éœ€è½¯ä»¶

### æ ¸å¿ƒä¾èµ–
- **Docker** (>= 20.10) + Docker Desktop
- **Go** (>= 1.19)
- **Node.js** (>= 16.x)
- **Python** (>= 3.8)
- **kubectl** (>= 1.25)
- **KinD** (Kubernetes in Docker)
- **jq** (JSON å¤„ç†å·¥å…·)

### å¯é€‰å·¥å…·
- **Newman** (Postman CLI æµ‹è¯•)
- **Helm** (Kubernetes åŒ…ç®¡ç†)
- **yq** (YAML å¤„ç†å·¥å…·)

## ğŸ—ï¸ æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    GitHub Repository                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚   CI Workflow   â”‚    â”‚   CD Workflow   â”‚                â”‚
â”‚  â”‚   (on push)     â”‚    â”‚   (on tag)      â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚               â”‚
                  â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Self-hosted Runner                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚   Docker    â”‚  â”‚   KinD      â”‚  â”‚   Tools     â”‚        â”‚
â”‚  â”‚   Images    â”‚  â”‚   Cluster   â”‚  â”‚   (Go, Node,â”‚        â”‚
â”‚  â”‚   Build     â”‚  â”‚   Deploy    â”‚  â”‚   Python)   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ CI/CD æµç¨‹

### æŒç»­é›†æˆ (CI)
è§¦å‘æ¡ä»¶ï¼šPush åˆ° `main` åˆ†æ”¯æˆ– Pull Request

1. **ç¯å¢ƒéªŒè¯**: æ£€æŸ¥æ‰€æœ‰å¿…éœ€å·¥å…·
2. **ä»£ç æ£€å‡º**: è·å–æœ€æ–°ä»£ç 
3. **ä¾èµ–å®‰è£…**: Goã€Node.jsã€Python ä¾èµ–
4. **ä»£ç æ„å»º**: ç¼–è¯‘æ‰€æœ‰æœåŠ¡
5. **é•œåƒæ„å»º**: æ„å»º Docker é•œåƒ
6. **é›†ç¾¤éƒ¨ç½²**: ä½¿ç”¨ KinD åˆ›å»ºæµ‹è¯•é›†ç¾¤
7. **çƒŸé›¾æµ‹è¯•**: åŸºç¡€åŠŸèƒ½æµ‹è¯•
8. **E2E æµ‹è¯•**: ç«¯åˆ°ç«¯æµ‹è¯•
9. **Postman æµ‹è¯•**: API é›†æˆæµ‹è¯•

### æŒç»­éƒ¨ç½² (CD)
è§¦å‘æ¡ä»¶ï¼šæ¨é€ç‰ˆæœ¬æ ‡ç­¾ (å¦‚ `v1.0.0`)

1. **é•œåƒæ„å»º**: æ„å»ºç”Ÿäº§é•œåƒ
2. **é•œåƒæ¨é€**: æ¨é€åˆ° GitHub Container Registry
3. **ç”Ÿäº§éƒ¨ç½²**: éƒ¨ç½²åˆ°ç”Ÿäº§ Kubernetes é›†ç¾¤ï¼ˆå¦‚æœé…ç½®äº† KUBE_CONFIGï¼‰

## ğŸ“Š å·¥ä½œæµçŠ¶æ€

### CI å·¥ä½œæµ
- âœ… **æ„å»ºéªŒè¯**: æ‰€æœ‰æœåŠ¡ç¼–è¯‘é€šè¿‡
- âœ… **é•œåƒæ„å»º**: Docker é•œåƒæ„å»ºæˆåŠŸ
- âœ… **æœ¬åœ°éƒ¨ç½²**: KinD é›†ç¾¤éƒ¨ç½²æµ‹è¯•
- âœ… **è‡ªåŠ¨åŒ–æµ‹è¯•**: åŒ…æ‹¬çƒŸé›¾æµ‹è¯•å’Œ E2E æµ‹è¯•

### CD å·¥ä½œæµ
- âœ… **ç‰ˆæœ¬å‘å¸ƒ**: è‡ªåŠ¨æ„å»ºå’Œæ¨é€é•œåƒ
- ğŸ”§ **ç”Ÿäº§éƒ¨ç½²**: éœ€è¦é…ç½® `KUBE_CONFIG` å¯†é’¥

## âš™ï¸ é…ç½®è¯´æ˜

### GitHub Secrets

åœ¨ä»“åº“çš„ Settings > Secrets and variables > Actions ä¸­é…ç½®ï¼š

| å¯†é’¥åç§° | æè¿° | å¿…éœ€ |
|---------|------|------|
| `GITHUB_TOKEN` | è‡ªåŠ¨æä¾›ï¼Œç”¨äºæ¨é€é•œåƒ | âœ… |
| `KUBE_CONFIG` | ç”Ÿäº§ Kubernetes é…ç½® (base64 ç¼–ç ) | ğŸ”§ |

### Runner æ ‡ç­¾

æ”¯æŒçš„ runner æ ‡ç­¾ï¼š
- `self-hosted`: åŸºç¡€æ ‡ç­¾
- `macOS`: macOS ç³»ç»Ÿ
- `Linux`: Linux ç³»ç»Ÿ  
- `Windows`: Windows ç³»ç»Ÿ
- `ARM64`: ARM æ¶æ„ï¼ˆApple Siliconï¼‰
- `X64`: x86_64 æ¶æ„

## ğŸ³ æœåŠ¡æ¶æ„

### å¾®æœåŠ¡ç»„ä»¶
- **Gateway**: API ç½‘å…³ (ç«¯å£ 80)
- **User Service**: ç”¨æˆ·ç®¡ç† (ç«¯å£ 8081)
- **Experiment Service**: å®éªŒç®¡ç† (ç«¯å£ 8082)
- **Notification Service**: é€šçŸ¥æœåŠ¡ (ç«¯å£ 8083)
- **Submission Service**: æäº¤ç®¡ç† (ç«¯å£ 8084)
- **Judge Service**: è¯„åˆ¤æœåŠ¡ (ç«¯å£ 8085)

### å‰ç«¯åº”ç”¨
- **SmartFox Frontend**: React åº”ç”¨ (ç«¯å£ 3000)

### æ•°æ®å­˜å‚¨
- **MySQL**: æ¯ä¸ªæœåŠ¡ç‹¬ç«‹çš„æ•°æ®åº“å®ä¾‹
- **æŒä¹…åŒ–å­˜å‚¨**: ä½¿ç”¨ Kubernetes PVC

## ğŸ”§ æœ¬åœ°å¼€å‘

### å¯åŠ¨å¼€å‘ç¯å¢ƒ
```bash
# æ¸…ç†ç°æœ‰é›†ç¾¤
kind delete cluster --name smartfox-ci

# è¿è¡Œå®Œæ•´æµ‹è¯•æµç¨‹
cd mirco_service_fox
.github/scripts/kind-deploy-and-test.sh
```

### å•ç‹¬æ„å»ºæœåŠ¡
```bash
# æ„å»ºç‰¹å®šæœåŠ¡
cd mirco_service_fox/user-service
go build ./...

# æ„å»º Docker é•œåƒ
docker build -t user-service:dev .
```

### å‰ç«¯å¼€å‘
```bash
cd smartfox_front
npm install
npm start
```

## ğŸ“ˆ æ€§èƒ½ç›‘æ§

### èµ„æºä½¿ç”¨æƒ…å†µ
- **å†…å­˜ç›‘æ§**: `top -o MEM`
- **Docker èµ„æº**: `docker stats`
- **ç£ç›˜ä½¿ç”¨**: `df -h`
- **ç½‘ç»œçŠ¶æ€**: `netstat -tuln`

### æ—¥å¿—æŸ¥çœ‹
```bash
# Runner æ—¥å¿—
tail -f ~/actions-runner/_diag/Runner_*.log

# ä½œä¸šæ—¥å¿—  
tail -f ~/actions-runner/_diag/Worker_*.log

# Kubernetes æ—¥å¿—
kubectl logs -f deployment/user-service
```

## ğŸ› ï¸ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **Docker æœªå¯åŠ¨**
   ```bash
   # macOS
   open /Applications/Docker.app
   
   # éªŒè¯
   docker info
   ```

2. **ç«¯å£è¢«å ç”¨**
   ```bash
   # æŸ¥çœ‹å ç”¨ç«¯å£çš„è¿›ç¨‹
   lsof -i :8080
   
   # ç»ˆæ­¢è¿›ç¨‹
   sudo kill -9 <PID>
   ```

3. **å†…å­˜ä¸è¶³**
   ```bash
   # æ¸…ç† Docker ç¼“å­˜
   docker system prune -a -f
   
   # æ¸…ç† KinD é›†ç¾¤
   kind delete cluster --name smartfox-ci
   ```

4. **æ„å»ºå¤±è´¥**
   ```bash
   # æ¸…ç† Go ç¼“å­˜
   go clean -modcache
   
   # æ¸…ç† npm ç¼“å­˜
   npm cache clean --force
   ```

### è·å–å¸®åŠ©

- ğŸ“– **æ–‡æ¡£**: æŸ¥çœ‹ `docs/` ç›®å½•ä¸­çš„è¯¦ç»†æŒ‡å—
- ğŸ› **é—®é¢˜æŠ¥å‘Š**: åœ¨ GitHub Issues ä¸­æäº¤é—®é¢˜
- ğŸ’¬ **è®¨è®º**: ä½¿ç”¨ GitHub Discussions è¿›è¡Œè®¨è®º

## ğŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

### å‘å¸ƒæ–°ç‰ˆæœ¬
```bash
# åˆ›å»ºç‰ˆæœ¬æ ‡ç­¾
git tag v1.0.0
git push origin v1.0.0

# CD å·¥ä½œæµå°†è‡ªåŠ¨è§¦å‘
```

### ç”Ÿäº§ç¯å¢ƒé…ç½®
1. å‡†å¤‡ Kubernetes é›†ç¾¤
2. é…ç½® `KUBE_CONFIG` å¯†é’¥
3. æ¨é€ç‰ˆæœ¬æ ‡ç­¾è§¦å‘éƒ¨ç½²

## ğŸ“š å‚è€ƒèµ„æ–™

- [Self-hosted Runner è®¾ç½®æŒ‡å—](docs/self-hosted-runner-setup-macos.md)
- [GitHub Actions å®˜æ–¹æ–‡æ¡£](https://docs.github.com/en/actions)
- [Docker å®˜æ–¹æ–‡æ¡£](https://docs.docker.com/)
- [Kubernetes å®˜æ–¹æ–‡æ¡£](https://kubernetes.io/docs/)
- [KinD ç”¨æˆ·æŒ‡å—](https://kind.sigs.k8s.io/)

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - æŸ¥çœ‹ [LICENSE](LICENSE) æ–‡ä»¶äº†è§£è¯¦æƒ…ã€‚

---

â­ å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œè¯·ç»™å®ƒä¸€ä¸ªæ˜Ÿæ ‡ï¼
