name: CI

on:
  push:
    branches: [ main, self]
  pull_request:
    branches: [ main, self]

permissions:
  contents: read

jobs:
  build-and-validate:
    runs-on: self-hosted  # ä½¿ç”¨ self-hosted runner
    timeout-minutes: 60   # å¢åŠ è¶…æ—¶æ—¶é—´ï¼Œå› ä¸ºæœ¬åœ°ç¯å¢ƒå¯èƒ½éœ€è¦æ›´å¤šæ—¶é—´
    defaults:
      run:
        shell: bash
        working-directory: mirco_service_fox
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # ç§»é™¤ setup-go actionï¼Œå‡è®¾ self-hosted runner å·²ç»å®‰è£…äº† Go
      - name: éªŒè¯Goç¯å¢ƒ
        run: |
          go version
          echo "Goç¯å¢ƒå·²å°±ç»ª"

      # ç§»é™¤ç¼“å­˜æ­¥éª¤ï¼Œä½¿ç”¨æœ¬åœ°ç¼“å­˜
      - name: æ¸…ç†Goæ¨¡å—ç¼“å­˜ (å¯é€‰)
        run: |
          echo "ä½¿ç”¨æœ¬åœ°Goæ¨¡å—ç¼“å­˜"
          go clean -modcache || true

      - name: ä¸‹è½½ Go æ¨¡å—ä¾èµ–
        env:
          GOPROXY: https://proxy.golang.org,direct
        run: |
          for d in gateway experiment-service user-service notification-service submission-service; do
            echo "==> go mod download in $d"
            (cd "$d" && go mod download)
          done

      - name: Go Build (gateway)
        run: |
          cd gateway
          go build ./...

      - name: Go Build (experiment-service)
        run: |
          cd experiment-service
          go build ./...

      - name: Go Build (user-service)
        run: |
          cd user-service
          go build ./...

      - name: Go Build (notification-service)
        run: |
          cd notification-service
          go build ./...

      - name: Go Build (submission-service)
        run: |
          cd submission-service
          go build ./...

      # ç§»é™¤ setup-python actionï¼Œå‡è®¾ self-hosted runner å·²ç»å®‰è£…äº† Python
      - name: éªŒè¯Pythonç¯å¢ƒ
        run: |
          python3 --version || python --version
          pip3 --version || pip --version
          echo "Pythonç¯å¢ƒå·²å°±ç»ª"

      - name: Python deps (judge-service)
        run: |
          cd judge-service
          python3 -m pip install -U pip || python -m pip install -U pip
          pip3 install -r requirements.txt || pip install -r requirements.txt
          python3 - <<'PY' || python - <<'PY'
          import flask
          print('Flask version:', flask.__version__)
          PY

      # ç§»é™¤ setup-node actionï¼Œå‡è®¾ self-hosted runner å·²ç»å®‰è£…äº† Node.js
      - name: éªŒè¯Nodeç¯å¢ƒ
        run: |
          node --version
          npm --version
          echo "Node.jsç¯å¢ƒå·²å°±ç»ª"

      - name: å®‰è£…å‰ç«¯ä¾èµ–å¹¶æ„å»º
        run: |
          cd ..
          cd smartfox_front
          npm ci
          CI=false npm run build

      # ç§»é™¤ docker/setup-buildx-actionï¼Œä½¿ç”¨æœ¬åœ° Docker
      - name: éªŒè¯Dockerç¯å¢ƒ
        run: |
          docker --version
          docker-compose --version || docker compose version || echo "Docker Compose not required for this step"
          echo "Dockerç¯å¢ƒå·²å°±ç»ª"

      - name: æ„å»ºdockeré•œåƒ
        run: |
          docker build -t gateway:ci ./gateway
          docker build -t experiment-service:ci ./experiment-service
          docker build -t user-service:ci ./user-service
          docker build -t notification-service:ci ./notification-service
          docker build -t submission-service:ci ./submission-service
          docker build -t judge-service:ci ./judge-service
          # frontend image (path out of mirco_service_fox)
          cd ..
          docker build -t smartfox-front:ci ./smartfox_front

      # ç§»é™¤ helm/kind-actionï¼Œä½¿ç”¨æœ¬åœ°å®‰è£…çš„ KinD
      - name: éªŒè¯KinDç¯å¢ƒ
        run: |
          kind --version
          kubectl version --client
          echo "KinDå’Œkubectlç¯å¢ƒå·²å°±ç»ª"

      - name: æ¸…ç†ä¹‹å‰çš„é›†ç¾¤ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        run: |
          kind delete cluster --name smartfox-ci || echo "é›†ç¾¤ä¸å­˜åœ¨ï¼Œè·³è¿‡åˆ é™¤"

      - name: Deploy to KinD and run smoke tests
        run: |
          chmod +x .github/scripts/kind-deploy-and-test.sh
          .github/scripts/kind-deploy-and-test.sh
          
      - name: ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨
        run: |
          echo "ç­‰å¾…æ‰€æœ‰æœåŠ¡å®Œå…¨å¯åŠ¨..."
          sleep 30
          
          # æ£€æŸ¥æ‰€æœ‰æœåŠ¡çš„å¥åº·çŠ¶æ€
          kubectl get pods -o wide
          kubectl get svc
          
          # ç­‰å¾…æ‰€æœ‰ Pod å°±ç»ª
          kubectl wait --for=condition=ready pod --all --timeout=300s || true
          
      - name: E2E smoke
        run: |
          # ä½¿ç”¨æœ¬åœ°å®‰è£…çš„ jqï¼Œå¦‚æœæ²¡æœ‰åˆ™å®‰è£…
          if ! command -v jq &> /dev/null; then
            if [[ "$OSTYPE" == "darwin"* ]]; then
              brew install jq
            elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
              sudo apt-get update && sudo apt-get install -y jq
            fi
          fi
          chmod +x .github/scripts/smoke-e2e.sh
          .github/scripts/smoke-e2e.sh
          
      - name: Postman é›†æˆæµ‹è¯•
        run: |
          # ç¡®ä¿è„šæœ¬å¯æ‰§è¡Œ
          chmod +x .github/scripts/run-newman.sh
          
          # ç¡®ä¿æµ‹è¯•æ–‡ä»¶å­˜åœ¨
          if [ ! -d "../test_json" ]; then
            echo "âŒ æµ‹è¯•ç›®å½• ../test_json ä¸å­˜åœ¨"
            exit 1
          fi
          
          # åˆ—å‡ºå¯ç”¨çš„æµ‹è¯•æ–‡ä»¶
          echo "ğŸ“‚ å¯ç”¨çš„æµ‹è¯•æ–‡ä»¶:"
          ls -la ../test_json/
          
          # è¿è¡Œ Postman æµ‹è¯•
          echo "ğŸš€ å¼€å§‹è¿è¡Œ Postman é›†æˆæµ‹è¯•..."
          .github/scripts/run-newman.sh
